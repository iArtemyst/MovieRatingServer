using MovieRating.Shared;
using System.Text.Json;
using System.Text.Json.Serialization;

namespace GatherMovieInfo
{
    internal class Program
    {
        const string RawIds = "tt30144839,tt26439764,tt0111161,tt0088763,tt16311594,tt0068646,tt32820897,tt0093773,tt0241527,tt0816692,tt0361748,tt14230458,tt26743210,tt1375666,tt0099785,tt0468569,tt0457430,tt0120737,tt0210945,tt0081505,tt15398776,tt0102926,tt0114369,tt0120689,tt0113277,tt0110912,tt0137523,tt0482571,tt6751668,tt0434409,tt0266697,tt7131622,tt0407887,tt0133093,tt1745960,tt0119217,tt1853728,tt2948356,tt0114814,tt2582802,tt0477348,tt0172495,tt0076759,tt0108052,tt0089218,tt0993846,tt1119646,tt0097165,tt0109830,tt2380307,tt15239678,tt1130884,tt2267998,tt1392214,tt0050083,tt0117381,tt0120338,tt8367814,tt0167404,tt0099685,tt5052448,tt0469494,tt0107290,tt0107688,tt0364569,tt1877830,tt0032138,tt1160419,tt8946378,tt0325980,tt0078748,tt0209144,tt0110413,tt0180093,tt0054215,tt0317248,tt0071562,tt0330373,tt0208092,tt1596363,tt14849194,tt0120382,tt0093779,tt1074638,tt0414387,tt5362988,tt0103064,tt0120815,tt1856101,tt0167260,tt6966692,tt4154796,tt2106476,tt0169547,tt0060196,tt0075314,tt0073486,tt2119532,tt0338013,tt4016934,tt0264464,tt0084787,tt1345836,tt0796366,tt1255953,tt0245429,tt0078788,tt0381061,tt0230600,tt1950186,tt0118799,tt0304141,tt3783958,tt0077651,tt0443706,tt0246578,tt7286456,tt1675434,tt0327056,tt29623480,tt0096874,tt0166924,tt0086250,tt6710474,tt0072890,tt0499549,tt0372784,tt0091251,tt0268978,tt3281548,tt0112573,tt3397884,tt0021884,tt0470752,tt0095016,tt0332280,tt1201607,tt2278388,tt2543164,tt0082971,tt0116282,tt0112641,tt0117666,tt8579674,tt0062622,tt0903624,tt0088247,tt0108358,tt0378194,tt0120586,tt0167261,tt9362722,tt0327597,tt1663202,tt0118749,tt0253474,tt3460252,tt0072431,tt0118715,tt0090605,tt0038650,tt2015381,tt3659388,tt0083658,tt1016150,tt10872600,tt1659337,tt0926084,tt2194499,tt0070047,tt23849204,tt0353969,tt1895587,tt0105236,tt1454029,tt0093058,tt0382932,tt0083866,tt1302006,tt5013056,tt0087332,tt0104257,tt0099487,tt0119116,tt2802144,tt0087843,tt0175880,tt4772188,tt27503384,tt1631867,tt13238346,tt5311514,tt0405094,tt0181875,tt0066921,tt0092005,tt1392190,tt0139654,tt1798709,tt0077416,tt0095327,tt0104952,tt0086879,tt0240772,tt0110357,tt0126029,tt0080684,tt0421715,tt10366460,tt10370710,tt0059742,tt0780504,tt0892769,tt2872718,tt4154756,tt14961016,tt1727824,tt0073195,tt0365748,tt0088847,tt6791350,tt8503618,tt5027774,tt0070735,tt0947798,tt2084970,tt0117951,tt1210166,tt0910970,tt3748528,tt0198781,tt1285016,tt0317705,tt0114709,tt0211915,tt0432283,tt1431045,tt2278871,tt0080339,tt0328107,tt0069947,tt17009710,tt0409459,tt0034583,tt0108399,tt0064116,tt4633694,tt1022603,tt4846340,tt0363163,tt0371746,tt0098635,tt13833688,tt0064115,tt2024544,tt4034228,tt0105323,tt0112471,tt0449059,tt0258463,tt0119488,tt10272386,tt1049413,tt0848228,tt0783233,tt11813216,tt1045658,tt2582782,tt0055031,tt5726616,tt0425112,tt0206634,tt0119177,tt0100157,tt0347149,tt2488496,tt1187043,tt34365591,tt1568346,tt0075148,tt0181689,tt1170358,tt0387564,tt0472043,tt0091042,tt8267604,tt0105695,tt0266543,tt0047478,tt1403865,tt0074119,tt0401792,tt0112384,tt0388795,tt2584384,tt1979320,tt0072684,tt4912910,tt0106977,tt0758758,tt0119174,tt1136608,tt0047396,tt0416449,tt0120735,tt0097576,tt1291584,tt0052357,tt0119698,tt2096673,tt1305806,tt0265086,tt0335266,tt0114746,tt0107048,tt23289160,tt0071315,tt0454921,tt0091763,tt0096163,tt0114388,tt0090756,tt0156887,tt0075686,tt0780536,tt0095953,tt15327088,tt3315342,tt0121766,tt0086190,tt0118694,tt0151804,tt0057012,tt2562232,tt0190590,tt0107943,tt0056058,tt0319061,tt4729430,tt1024648,tt0099077,tt0936501,tt0056172,tt0162222,tt0095765,tt0104691,tt0026138,tt0325710,tt0031381,tt5323662,tt0089881,tt0106489,tt0289879,tt0398286,tt3011894,tt12361974,tt0071853,tt0405159,tt0765429,tt0063522,tt2948372,tt0080455,tt2543472,tt0790636,tt0450259,tt0096283,tt0435761,tt0067992,tt0756683,tt4857264,tt0245844,tt4468740,tt1454468,tt0033467,tt3170832,tt0245574,tt5463162,tt0113247,tt0101414,tt0375679,tt0454876,tt1588170,tt5104604,tt0914798,tt1408101,tt3501632,tt0460791,tt1010048,tt0441773,tt0082096,tt1139797,tt0119008,tt0081398,tt10288566,tt1504320,tt1205489,tt0361862,tt3915174,tt0107818,tt3498820,tt1748122,tt1065073,tt0058331,tt0381681,tt1843866,tt0108550,tt0056592,tt0094625,tt0108037,tt0061722,tt0094226,tt0129167,tt1028532,tt0119822,tt0071230,tt0088680,tt1605783,tt7653254,tt0099348,tt8613070,tt3741834,tt0053125,tt1270798,tt0057115,tt0053604,tt0485947,tt0043014,tt0120762,tt1535109,tt3553976,tt0087884,tt0103639,tt2245084,tt0079944,tt0088258,tt0085334,tt0140352,tt0132477,tt0036775,tt0120363,tt0080678,tt1070874,tt1877832,tt0083944,tt1683526,tt0276919,tt0069762,tt1979376,tt27540542,tt0107207,tt0102138,tt0045152,tt0063442,tt0057565,tt16277242,tt1832382,tt20561198,tt0190332,tt1182345,tt0096438,tt0381849,tt5363618,tt0964517,tt26548265,tt0053291,tt1772341,tt5074352,tt0120601,tt0109424,tt0017136,tt1646971,tt8178634,tt0052618,tt1954470,tt0110729,tt0050976,tt0104348,tt8239946,tt0093870,tt0071360,tt0051201,tt1490017,tt0861739,tt0088846,tt3416742,tt0379786,tt0113568,tt0059578,tt0041959,tt0050825,tt1132620,tt0058150,tt0047296,tt0070511,tt0268126,tt11032374,tt4849438,tt0106519,tt2631186,tt0054331,tt2980516,tt0395169,tt0056923,tt0257044,tt0022100,tt0440963,tt23736044,tt9660502,tt14331144,tt0851578,tt0372183,tt0074958,tt2209418,tt0358273,tt0144117,tt0352248,tt0076740,tt12262116,tt0986264,tt0092965,tt6155172,tt0065214,tt0048424,tt0346336,tt0245712,tt7979580,tt0033870,tt4698684,tt0046912,tt0068473,tt0063350,tt0067328,tt0097814,tt0058461,tt0168629,tt0147612,tt0130827,tt1398426,tt0817177,tt1220719,tt0373074,tt0044741,tt0824747,tt0050212,tt0054047,tt0067116,tt0350258,tt2013293,tt0420332,tt0049833,tt0042192,tt0092991,tt0104684,tt0042876,tt0056869,tt0876563,tt0032553,tt0299977,tt0053472,tt15097216,tt20850406,tt0064665,tt0101507,tt0059113,tt0039628,tt0088939,tt0069293,tt0166896,tt5198068,tt0079470,tt0338564,tt0097216,tt0092067,tt0455590,tt0056801,tt0040522,tt0315733,tt2358891,tt0027977,tt0032976,tt1216496,tt0085794,tt0091605,tt0978762,tt0013442,tt2070649,tt0087544,tt0101921,tt0081283,tt1125849,tt0078754,tt0425210,tt0097441,tt0071615,tt0118849,tt0112870,tt0104797,tt1190539,tt1924396,tt0072417,tt0058083,tt0244316,tt7466810,tt0091167,tt0052561,tt0066999,tt0079417,tt0036868,tt0058946,tt0093191,tt0021749,tt0079522,tt0061512,tt0055630,tt0169858,tt0070666,tt0056218,tt4430212,tt8075192,tt0046359,tt2356180,tt0032904,tt0058385,tt0095647,tt7236034,tt0249462,tt0046250,tt0077402,tt0108394,tt0104940,tt1655442,tt0093389,tt4302938,tt10698680,tt0075029,tt0043265,tt0104652,tt0109707,tt0056687,tt0077405,tt0061578,tt0049406,tt1602620,tt0049730,tt0109445,tt0066206,tt0046438,tt1527788,tt0060827,tt0049366,tt0078841,tt0498380,tt0053779,tt0097937,tt0083987,tt1821549,tt0100150,tt0072443,tt0050986,tt2350496,tt0032551,tt0106469,tt1235166,tt0061811,tt0070510,tt0154420,tt8108198,tt0040897,tt2338151,tt0480025,tt0044081,tt0061184,tt0053221,tt0120265,tt0116477,tt0038355,tt0388473,tt10295212,tt21626284,tt3544112,tt0907657,tt0044079,tt0056197,tt0083922,tt0300140,tt0308644,tt0025316,tt0111495,tt0087553,tt0068327,tt2576852,tt1865505,tt1365050,tt0062229,tt2265171,tt0318462,tt0061418,tt0040746,tt0048028,tt0019254,tt0045555,tt0052311,tt0057091,tt0389557,tt0086197,tt0113824,tt0038787,tt2370248,tt0017925,tt0056217,tt2582496,tt0067093,tt0031679,tt0091670,tt0054997,tt8948790,tt0115751,tt0067185,tt0037008,tt0035446,tt0036855,tt0065234,tt0125659,tt0039689,tt0046268,tt0068182,tt0015864,tt10431500,tt4080728,tt0020629,tt0117589,tt0044706,tt0476735,tt0036613,tt0036342,tt0248845,tt0100998,tt1555149,tt3262342,tt0060665,tt0022913,tt0030993,tt1188996,tt0040725,tt0301357,tt0080979,tt15109082,tt7060344,tt0039192,tt0065531,tt0412080,tt0032599,tt0084726,tt0408664,tt0084855,tt0808417,tt0055018,tt0120731,tt0012349,tt0092048,tt0023427,tt0097202,tt0287467,tt0049902,tt7838252,tt0032455,tt1149362,tt0015324,tt0058777,tt0063227,tt0369702,tt0043456,tt0185125,tt0252488,tt0024216,tt0010323,tt0053198,tt0114787,tt9179430,tt5116302,tt7019842,tt0037382,tt6878038,tt0037558,tt0401383,tt26458038,tt0071129,tt1827487,tt0102536,tt0046911,tt0053946,tt0083946,tt0050783,tt0291350,tt0033045,tt0073341,tt0106332,tt0040724,tt3612616,tt0374546,tt9900782,tt0062136,tt5186714,tt0051459,tt2758880,tt5168192,tt4901306,tt0247586,tt0058450,tt0118767,tt0372824,tt8633462,tt0061735,tt0051036,tt0347048,tt0061809,tt0029947,tt1562872,tt0367110,tt0030341,tt0031971,tt1639426,tt6316138,tt0060107,tt0086022,tt0423866,tt1032846,tt4679210,tt0065571,tt0043924,tt0871510,tt6628102,tt0089853,tt0044008,tt0069467,tt0015648,tt0106364,tt0100234,tt0084503,tt0077711,tt0051808,tt0052893,tt0042593,tt0293715,tt0042208,tt0376968,tt0107692,tt16492678,tt2140203,tt0418455,tt0260991,tt1069238,tt0286244,tt3841424,tt5311542,tt0870111,tt0050613,tt0043338,tt0074896,tt0118843,tt0056111,tt0037913,tt0158983,tt7392212,tt0374887,tt0347304,tt0275277,tt0056443,tt2331143,tt0062467,tt0283509,tt3863552,tt3169706,tt0051378,tt0056732,tt9263550,tt2082197,tt0250258,tt4635372,tt3668162,tt4934950,tt10189514,tt0064040,tt1702014,tt0292490,tt0037884,tt3901826,tt1327035,tt0055499,tt0068361,tt0054130,tt1821480,tt0047528,tt5571734,tt0073707,tt0860906,tt0097123,tt0038733,tt0023969,tt1280558,tt0140888,tt15501640,tt0092593,tt0055601,tt10280296,tt0055852,tt0169102,tt0069281,tt8291224,tt0097223,tt0018455,tt0042546,tt0025878,tt0038348,tt0040506,tt0070460,tt0046478,tt2991224,tt0405508,tt0110877,tt3390572,tt0029843,tt0038890,tt2321405,tt2181931,tt1620933,tt2024519,tt0053619,tt0338309,tt0057358,tt9052870,tt0384116,tt0119472,tt0028950,tt3417422,tt7485048,tt0038762,tt0075824,tt0071411,tt0048473,tt0041546,tt0034240,tt0351817,tt0101640,tt0367495,tt0033729,tt1093370,tt0880502,tt0036244,tt0466460,tt0095467,tt0401085,tt24485052,tt0042041,tt2317337,tt1360860,tt2395469,tt0093603,tt4285496,tt0116231,tt4169250,tt0053976,tt0028010,tt0055824,tt0428870,tt5764096,tt2377938,tt0375611,tt2283748,tt0242519,tt0045274,tt0091288,tt9477520,tt0031885,tt0038574,tt0048021,tt2404461,tt0456144,tt0056663,tt10324144,tt0263438,tt3848892,tt0109117,tt1171701,tt0323013,tt0270053,tt0018773,tt7218518,tt7725596,tt0066763,tt3322420,tt11580854,tt2659414,tt6148156,tt0200087,tt4387040,tt12361178,tt0386064,tt0104561,tt0026778";
        const string OutPath = ".\\movie-list.json";

        public static async Task Main(string[] args)
        {
            string[] ids = RawIds.Split(',');

            HttpClient client = new HttpClient()
            {
                BaseAddress = new Uri("http://www.omdbapi.com"),
            };

            int currentIndex = 0;
            List<RawMovie> movieList = new List<RawMovie>();
            try
            {
                for (int i = 0; i < ids.Length; i++)
                {
                    currentIndex = i;
                    string id = ids[i];
                    var request = new HttpRequestMessage(HttpMethod.Get, new Uri($"?i={id}&apiKey={Constants.ApiKey}", UriKind.Relative));
                    var response = await client.SendAsync(request);
                    response.EnsureSuccessStatusCode();

                    var json = await response.Content.ReadAsStringAsync();
                    RawMovie movie = JsonSerializer.Deserialize<RawMovie>(json) ?? throw new Exception("Failed to deserialize to RawMovie");
                    movieList.Add(movie);

                    Console.WriteLine(movie.Title);

                    await Task.Delay(500);
                }
            }
            catch
            {
                Console.WriteLine($"Failed at index {currentIndex}");
                Console.WriteLine("Remaining ids:");
                Console.WriteLine(string.Join(",", ids.Skip(currentIndex)));
            }

            RawMovieList rawMovieList = new RawMovieList() { MovieDatabase = movieList };
            await File.WriteAllTextAsync(Path.GetFullPath(OutPath), JsonSerializer.Serialize(rawMovieList, new JsonSerializerOptions() { WriteIndented = true }));

            Console.WriteLine($"Done. Wrote {rawMovieList.MovieDatabase.Count} movies to {Path.GetFullPath(OutPath)}");
        }
    }
}
