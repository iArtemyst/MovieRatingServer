using MovieRating.Shared;
using System.Text.Json;
using System.Text.Json.Serialization;

namespace GatherMovieInfo
{
    internal class Program
    {
        const string RawIds = "tt6208148,tt10886166,tt6203702,tt13186306,tt12996154,tt0118688,tt0157262,tt1073498,tt26533869,tt8366590,tt0795461,tt31456973,tt1530509,tt6479178,tt1098327,tt0368226,tt21106646,tt9104736,tt1666186,tt20258920,tt9603060,tt1572311,tt0799949,tt0220506,tt19623240,tt5697572,tt30956852,tt0109770,tt11012066,tt1255919,tt1213644,tt4877122,tt0119707,tt0938283,tt27714840,tt0785077,tt0424774,tt1883367,tt29252358,tt0329028,tt6988116,tt0362165,tt1153706,tt0327554,tt2467046,tt0822833,tt0076009,tt4667094,tt0190374,tt1411664,tt5690360,tt0432291,tt0450345,tt0158622,tt0115624,tt0110978,tt31122323,tt1714203,tt0810913,tt0120185,tt0466342,tt7897330,tt0369226,tt6513656,tt10481868,tt4058836,tt7959500,tt3138104,tt0094074,tt1830786,tt0116756,tt0383222,tt7588752,tt0093300,tt0811138,tt30007864,tt0291502,tt31712434,tt1231277,tt3832096,tt12915716,tt1273221,tt1185266,tt0275022,tt14174168,tt4029412,tt0806147,tt7608028,tt0180052,tt30743549,tt0083170,tt1517489,tt0080596,tt0086987,tt0492389,tt0185183,tt0410332,tt2292959,tt0095560,tt7312940,tt0300657,tt0246894,tt0118665,tt0829424,tt12528166,tt0299930,tt0052077,tt0460780,tt0365957,tt0317676,tt2403029,tt35518081,tt0085750,tt7059844,tt1852770,tt13788842,tt11348232,tt21391242,tt1139592,tt27162102,tt18072316,tt0105643,tt0165494,tt9820556,tt10888594,tt0295427,tt0059199,tt23556408,tt0089308,tt11762434,tt0065832,tt12335692,tt5431600,tt15331186,tt0093974,tt4685806,tt1523267,tt7668842,tt7286836,tt0897361,tt0094750,tt0093072,tt0058548,tt1316037,tt0120207,tt0887719,tt27682129,tt0093227,tt0077189,tt0110169,tt29454492,tt0118661,tt14656632,tt0080771,tt0415160,tt12598606,tt0110647,tt0339034,tt4262516,tt5617916,tt0064373,tt0106913,tt10279472,tt1352388,tt2610768,tt0804492,tt3894312,tt12311866,tt0829176,tt0118836,tt15837458,tt0060666,tt9365800,tt1552211,tt0106761,tt12830948,tt2136808,tt0891592,tt0092532,tt0103923,tt1716747,tt14121726,tt12163074,tt27047448,tt0462244,tt13265876,tt12636872,tt12483708,tt5737536,tt0364376,tt37836776,tt0295254,tt30422937,tt7431594,tt11697484,tt0308208,tt0400426,tt2226666,tt1718158,tt0073043,tt0094077,tt5013984,tt0093582,tt6593054,tt1594972,tt7133754,tt3093522,tt7886848,tt3053228,tt0108187,tt11656172,tt25869142,tt0085183,tt0087700,tt2268433,tt0411806,tt3598222,tt4227282,tt8610036,tt0098156,tt8809652,tt0052846,tt0054768,tt0053611,tt0044406,tt0119203,tt6215044,tt0376717,tt0768222,tt1091617,tt14849038,tt3350996,tt0110857,tt9196192,tt1223922,tt5656994,tt15334030,tt0096870,tt7510346,tt16496386,tt1918886,tt1522846,tt0086325,tt1009017,tt9624766,tt0119576,tt11161374,tt14265992,tt0283054,tt0201844,tt0249516,tt0065904,tt1107812,tt0094824,tt23063732,tt4435072,tt0327643,tt2574698,tt4009460,tt0804452,tt0103927,tt0082910,tt6439558,tt0101615,tt3016748,tt7286966,tt4940336,tt7255568,tt0104837,tt0094118,tt2041331,tt22805590,tt3399484,tt0270846,tt7976208,tt35295730,tt18939362,tt0101264,tt20258220,tt9495690,tt2609218,tt4675030,tt2980152,tt15670222,tt7541720,tt3679040,tt8328716,tt6170506,tt7721946,tt0049092,tt13259610,tt26258488,tt14577300,tt5717194,tt0084316,tt3558642,tt27747488,tt13432484,tt15262370,tt6469960,tt1702009,tt21435436,tt10047958,tt27458291,tt0051993,tt0372873,tt13694706,tt0367677,tt14412366,tt8066940,tt6117702,tt0490196,tt5235880,tt9248934,tt4141368,tt0758781,tt0120389,tt3588588,tt3398252,tt0118539,tt0054240,tt7295450,tt8363392,tt17595094,tt0763304,tt0118589,tt0106521,tt0353324,tt1659216,tt18394428,tt1684555,tt1651323,tt2313189,tt8983220,tt11591424,tt12519802,tt12861508,tt10350922,tt0028346,tt0090771,tt1229827,tt0405977,tt0489244,tt6710826,tt13334578,tt0421051,tt1045655,tt1702443,tt2576450,tt13904644,tt0053337,tt11696276,tt1764366,tt0218619,tt14315500,tt0086486,tt0096149,tt0422779,tt0120598,tt37846979,tt2439946,tt0323808,tt14865406,tt0117350,tt0095241,tt0417056,tt0055294,tt0342689,tt0265148,tt12810902,tt15438542,tt2854394,tt7052270,tt0499487,tt0099656,tt0090333,tt6038600,tt10957044,tt8746404,tt1884318,tt2207484,tt2025667,tt0326983,tt0092297,tt0089274,tt2071491,tt3242756,tt4557208,tt0462395,tt0097174,tt2976182,tt13067292,tt2043757,tt13496236,tt0858411,tt1144804,tt5290620,tt0116165,tt0093872,tt0116839,tt4511566,tt10739666,tt10598156,tt0093405,tt12132908,tt0107612,tt2345613,tt1986857,tt4556370,tt0089280,tt1001562,tt8361196,tt0086955,tt21326658,tt6053472,tt4743226,tt0113074,tt1754811,tt7221896,tt0411805,tt0800003,tt0232079,tt27610677,tt9648672,tt0077834,tt0298296,tt0114658,tt2325518,tt3477064,tt8804580,tt11423214,tt3382148,tt0266747,tt0055946,tt11276598,tt0825283,tt4796122,tt4184878,tt0093516,tt7399138,tt21045742,tt4059702,tt1158700,tt5344794,tt2040578,tt0091934,tt28282872,tt5932368,tt25403492,tt3462696,tt0073396,tt3551400,tt3526286,tt0312700,tt0122961,tt11873440,tt5340882,tt10263320,tt4416518,tt3726012,tt0995752,tt0893509,tt0077300,tt8130518,tt4007558,tt20864606,tt0088100,tt10553210,tt5842616,tt11176322,tt15281656,tt4480398,tt1844770,tt0064048,tt0059878,tt0196158,tt0096804,tt0076809,tt2268573,tt1038685,tt0093873,tt3499458,tt0086972,tt0067017,tt11563070,tt0120627,tt0046248,tt0085518,tt0088380,tt4060544,tt15302290,tt10509906,tt13686748,tt14398312,tt0373908,tt3569356,tt0117550,tt0095382,tt3261302,tt9558612,tt5759590,tt13157970,tt2518848,tt13131610,tt1147687,tt1993391,tt0103617,tt0057181,tt5988370,tt0099978,tt0380277,tt11112526,tt0145529,tt0116341,tt0403935,tt3165608,tt2113792,tt0117102,tt3384904,tt0086026,tt0182996,tt0382028,tt23474462,tt0936471,tt0077199,tt7136736,tt0064338,tt1560954,tt1629439,tt15891396,tt0426550,tt1988781,tt1263800,tt3488056,tt3923004,tt0257510,tt0203408,tt0053241,tt0118577,tt1241330,tt8170298,tt7052244,tt2034176,tt1520498,tt0086141,tt0054673,tt6360872,tt0047149,tt0955411,tt1767319,tt19857862,tt0047127,tt0056405,tt9126944,tt9101540,tt4616250,tt1686018,tt1996226,tt0418627,tt1791681,tt1674047,tt4867110,tt5470222,tt0063790,tt20414228,tt0263728,tt0808240,tt5456546,tt1827354,tt1745672,tt1712159,tt0109376,tt1650433,tt1754700,tt0201290,tt4467202,tt0084796,tt0081693,tt7296862,tt0330994,tt9592496,tt0456014,tt2199251,tt0081027,tt0058208,tt11199310,tt12283788,tt1320296,tt4547120,tt4949290,tt9534808,tt5161376,tt0072666,tt4898730,tt2379386,tt1093906,tt3705822,tt13893190,tt0462359,tt6089700,tt2492344,tt8489384,tt0473024,tt0106257,tt0025465,tt1756427,tt0066476,tt2147365,tt4247682,tt1594917,tt1343704,tt1698008,tt0473310,tt2226321,tt1172060,tt0199481,tt0426615,tt2357489,tt0168172,tt3367686,tt3343868,tt0770810,tt0061191,tt11792734,tt3848938,tt0360916,tt1388359,tt1451763,tt29456689,tt8235296,tt4669278,tt0115471,tt3187378,tt3781762,tt11612890,tt0156843,tt0061456,tt5427032,tt2417650,tt8064418,tt6910020,tt3266724,tt7851428,tt7138894,tt12058582,tt4175888,tt0490170,tt1604560,tt4073890,tt0074434,tt1331329,tt0087258,tt6422938,tt22099068,tt4205896,tt7813294,tt8268916,tt2974050,tt6255230,tt5154466,tt2344678,tt8972556,tt7820846,tt1540767,tt11486994,tt2905674,tt3036740,tt5581752,tt0833476,tt12774526,tt1780983,tt0362942,tt0139465,tt3289080,tt1038072,tt0174685,tt0371920,tt6973386,tt2369041,tt13468976,tt6984230,tt16986596,tt8439934,tt1716753,tt0368668,tt10930586,tt8955940,tt0415345,tt5152640,tt0364986,tt4743562,tt11924476,tt6916502,tt2518926,tt7263040,tt4404474,tt8318702,tt0088772,tt1785669,tt0452668,tt0075343,tt0463392,tt0057859,tt0112634,tt7535868,tt7461372,tt9115574,tt2814362,tt13117446,tt0054333,tt0479199,tt14292086,tt2446502,tt8485548,tt3499424,tt0470993,tt0205418,tt0493417,tt0059464,tt6982794,tt3655682,tt0060168,tt2803940,tt1403862,tt0404090,tt0100665,tt1127884,tt1196334,tt2240312,tt11027288,tt0247911,tt1833879,tt3013528,tt3152098,tt14723224,tt31115432,tt8651780,tt0057507,tt0756703,tt10247678,tt0476550,tt1560950,tt1836212,tt0049615,tt6243370,tt1623780,tt1060249,tt0469683,tt6684976,tt23047172,tt6289452,tt3108604,tt7754540,tt7014430,tt11529348,tt4205718,tt2991516,tt1047449,tt8479346,tt8655738,tt2321341,tt8402090,tt1203517,tt5768992,tt5059782,tt1133995,tt1087856,tt0071198,tt8941422,tt2396701,tt1191971,tt7624840,tt0054691,tt11127256,tt1323946,tt0053464,tt1656171,tt0427323,tt0060753,tt4269310,tt1202222,tt8464364,tt13651858,tt1289437,tt17081088,tt7546486,tt8370274,tt4898564,tt7642500,tt4351684,tt1187047,tt0278259,tt4985848,tt2396436,tt7130192,tt0425743,tt0058615,tt1579232,tt11964084,tt5258074,tt2062661,tt10126136,tt7607940,tt0494501,tt1733578,tt8638524,tt0050717,tt3743362,tt1879012,tt10342228,tt10885444,tt2364842,tt7974772,tt4907206,tt21279138,tt0052378,tt1174041,tt2181298,tt11900398,tt7250358,tt8997134,tt1286163,tt1699513,tt6068978,tt1309000,tt10165918,tt1179067,tt0037798,tt1728973,tt4966046,tt0830861,tt0279695,tt7642878,tt0055562,tt2495980,tt0493404,tt6175486,tt1205071,tt9144672,tt9562694,tt1570619,tt0112873,tt1087474,tt3374816,tt6609088,tt5679554,tt5237980,tt11350284,tt3552892,tt31451148,tt0162930,tt12283738,tt14668224,tt0369738,tt8548792,tt10920190,tt3043630,tt13423846,tt0756654,tt6772946,tt0478737,tt2069935,tt5702566,tt2948078,tt11343416,tt1124396,tt0451109,tt7265634,tt6090044,tt4114762,tt11581264,tt10319486,tt2736932,tt1247400,tt3671086,tt0424873,tt14403632,tt12757372,tt9646548,tt0949751,tt8722252,tt13209832,tt4458206,tt14878948,tt1920846,tt9681250,tt0400172,tt15290106,tt0074260,tt19289040,tt6990206,tt4662396,tt0300922,tt4717194,tt0953989,tt1189383,tt7512492,tt13439744,tt3155734,tt10132196,tt0758763,tt7765778,tt5608972,tt4172402,tt4937114,tt3188994,tt0929809,tt6271432,tt1171709,tt6830716,tt11426546,tt15558182,tt5944812,tt4875960,tt5265980,tt18561380,tt0969653,tt8482492,tt7535666,tt3735332,tt0315775,tt13617604,tt0120214,tt0470833,tt0451284,tt8196692,tt0464320,tt0845424,tt9364684,tt8098480,tt10264340,tt1754029,tt1431240,tt13332610,tt1820462,tt8569206,tt9165634,tt8671462,tt8018008,tt27648380,tt1097000,tt8081062,tt16228146,tt10515340,tt0469849,tt15353450,tt15767726,tt12839816,tt1300854,tt6495056";
        const string OutPath = ".\\movie-list.json";

        public static async Task Main(string[] args)
        {
            string[] ids = RawIds.Split(',');

            HttpClient client = new HttpClient()
            {
                BaseAddress = new Uri("http://www.omdbapi.com"),
            };

            int currentIndex = 0;
            List<RawMovie> movieList = new List<RawMovie>();
            try
            {
                for (int i = 0; i < ids.Length; i++)
                {
                    currentIndex = i;
                    string id = ids[i];
                    var request = new HttpRequestMessage(HttpMethod.Get, new Uri($"?i={id}&apiKey={Constants.ApiKey}", UriKind.Relative));
                    var response = await client.SendAsync(request);
                    response.EnsureSuccessStatusCode();

                    var json = await response.Content.ReadAsStringAsync();
                    RawMovie movie = JsonSerializer.Deserialize<RawMovie>(json) ?? throw new Exception("Failed to deserialize to RawMovie");
                    movieList.Add(movie);

                    Console.WriteLine(movie.Title);

                    await Task.Delay(250);
                }
            }
            catch
            {
                Console.WriteLine($"Failed at index {currentIndex}");
                Console.WriteLine("Remaining ids:");
                Console.WriteLine(string.Join(",", ids.Skip(currentIndex)));
            }

            RawMovieList rawMovieList = new RawMovieList() { MovieDatabase = movieList };
            await File.WriteAllTextAsync(Path.GetFullPath(OutPath), JsonSerializer.Serialize(rawMovieList, new JsonSerializerOptions() { WriteIndented = true }));

            Console.WriteLine($"Done. Wrote {rawMovieList.MovieDatabase.Count} movies to {Path.GetFullPath(OutPath)}");
        }
    }
}
